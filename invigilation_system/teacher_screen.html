<html>
  <head>
  </head>
  <body>
    <div id="student_video_list">
    </div>
  </body>
  <script src="../socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    // 連線到 Server Port
    const socket = io('http://localhost:3000');
    const signalOption = {
      offerToReceiveAudio: 1, // 是否傳送聲音流給對方
      offerToReceiveVideo: 1, // 是否傳送影像流給對方
    };
    const configuration = {
      iceServers: [{
        urls: 'stun:stun.l.google.com:19302' // Google's public STUN server
      }]
    };
    // Client
    socket.on('student_to_teacher', async (video_message) => {
      console.log('============================= testgregeg =======================');
      console.log(video_message);
      if(video_message.student_id) {
        if($("#" + video_message.student_id).length <= 0) {
          createStudentVideoDiv(video_message.student_id);
        }

        $(`#${video_message.student_id}_label`).text(video_message.student_id + ': ' + video_message.student_name);
        
        var share_screen_video = await createPeerConnectionInstance(video_message, 'share_screen');
        var video_call_video = await createPeerConnectionInstance(video_message, 'video_call');
        socket.emit("teacher_to_student", {
          student_id: video_message.student_id, 
          student_name: video_message.student_name, 
          share_screen_video: share_screen_video.localDescription,
          video_call_video: video_call_video.localDescription,
        });
      }
    });

    async function createPeerConnectionInstance(video_message, type) {
        localstream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        let video_element;
        var mediaRecorder;
        if(type == 'share_screen') {
          video_element = document.querySelector(`[id='${video_message.student_id}_share_screen_video']`);
        } else if(type == 'video_call') {
          video_element = document.querySelector(`[id='${video_message.student_id}_video_call_video']`);
        } else {
          console.log('error video type!!!!');
        }

        var peerConnectionInstance = new RTCPeerConnection(configuration);
        peerConnectionInstance.addStream(localstream.clone())
        peerConnectionInstance.onicecandidate = ({ candidate }) => {
          if (!candidate) { return; }
          socket.emit("teacher_to_student", {
            type: type,
            candidate: candidate
          });
        };
        peerConnectionInstance.oniceconnectionstatechange = (evt) => {
          console.log('===== 4 on ice connection state change =====');
          console.log('類別: ', type, ', 時間: ', new Date().getTime());
          console.log('ICE 伺服器狀態變更 => ', evt.target.iceConnectionState);
          if (evt.target.iceConnectionState == 'connected') {
            console.log('學生: ', video_message.student_id, ', 類別: ', type, ', ICE 伺服器成功連線');
            console.log(video_element.srcObject);
            
            const chunks = [];
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = e => {
              const blob = new Blob(chunks, { type: chunks[0].type });
              console.log(blob);
              // video_element.srcObject.getVideoTracks()[0].stop();

              filename = video_message.student_id + '_' + type + '.mp4';
              if(window.navigator.msSaveOrOpenBlob) {
                  window.navigator.msSaveBlob(blob, filename);
              } else {
                  var download_button = window.document.createElement('a');
                  download_button.href = window.URL.createObjectURL(blob);
                  download_button.download = filename;
                  if(type == 'share_screen') {
                    download_button.innerHTML = "桌面分享下載";
                  } else if(type == 'video_call') {
                    download_button.innerHTML = "視訊下載";
                  }
                  $(`#${video_message.student_id}_download_button`).append(download_button);
            
                  // document.body.appendChild(download_button);
                  // elem.click();     
                  // document.body.removeChild(elem);
              }
            };
            mediaRecorder.start();
          } else if(evt.target.iceConnectionState == 'disconnected') {
            mediaRecorder.stop();
          }
        };

        peerConnectionInstance.onaddstream = (event) => {
          if(!video_element.srcObject && event.stream){
            console.log('新增串流成功');
            video_element.srcObject = event.stream;
            mediaRecorder = new MediaRecorder(video_element.srcObject);
          }

          video_element.addEventListener('click', async function() {
            if (video_element.requestFullscreen) {
              video_element.requestFullscreen();
            } else if (video_element.webkitRequestFullscreen) { /* Safari */
              video_element.webkitRequestFullscreen();
            } else if (video_element.msRequestFullscreen) { /* IE11 */
              video_element.msRequestFullscreen();
            }
          });
        }
        // desc 指的是 Offer 與 Answer
        // currentRemoteDescription 代表的是最近一次連線成功的相關訊息
        try {
          if (type == 'share_screen' && video_message.share_screen_video && !peerConnectionInstance.currentRemoteDescription) {
              await peerConnectionInstance.setRemoteDescription(new RTCSessionDescription(video_message.share_screen_video));
          } else if(type == 'video_call' && video_message.video_call_video && !peerConnectionInstance.currentRemoteDescription) {
              await peerConnectionInstance.setRemoteDescription(new RTCSessionDescription(video_message.video_call_video));
          }
          // 呼叫 peerConnect 內的 createOffer / createAnswer
          var peerOfferSdpDescription = await peerConnectionInstance[`createAnswer`](signalOption);
          // 設定本地流配置
          await peerConnectionInstance.setLocalDescription(peerOfferSdpDescription);

          if (video_message.candidate) {
            // 新增對方 IP 候選位置
            peerConnectionInstance.addIceCandidate(new RTCIceCandidate(video_message.candidate));
          }

          return peerConnectionInstance;
        } catch(err) {
          console.log(err);
        }
    }

    function createStudentVideoDiv(student_id) {
      $("#student_video_list").append(`
        <div id="${student_id}" style="display: inline-block">
          <div><label id="${student_id}_label"></label></div>
          <div id="${student_id}_video_list">
            <video width="25%" height="25%" autoplay id="${student_id}_share_screen_video" playsinline></video>
            <video width="25%" height="25%" autoplay id="${student_id}_video_call_video" playsinline></video> 
          </div>
          <div id="${student_id}_download_button"></div>
        </div>
      `);
    }
    
    socket.emit('joinRoom' , 'teacher_room');
  </script>
</html>