<html>
  <head>
  </head>
  <body>
    <div>
      <label id = "studentName"></label>
        <video width="1000" height="1000" autoplay
          id="shareScreenVideo" muted playsinline></video>
        <video width="1000" height="1000" autoplay
          id="videoCallVideo" muted playsinline></video>

          <button class="sendStreamRequestBtn">send stream</button>
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script>

    // 連線到 Server Port
    const socket = io('http://localhost:3000');

    const shareScreenVideo = document.querySelector('#shareScreenVideo');
    const videoCallVideo = document.querySelector('#videoCallVideo');
    let localShareScreenVideoStream;
    let localVideoCallVideoStream;
    let rtcPeerConnectionInstance;

    // const studentName = prompt('請輸入你的名字');
    // $('#studentName').text(studentName);
    const studentName = new Date();
    const sendStreamRequestBtn = document.querySelector('.sendStreamRequestBtn');

    const signalOption = {
      offerToReceiveAudio: 1, // 是否傳送聲音流給對方
      offerToReceiveVideo: 1, // 是否傳送影像流給對方
    };

    // Client
    socket.on('teacherSendToStudentSignaling', async (message) => {
      if (message.video && !rtcPeerConnectionInstance.currentRemoteDescription) {
        await rtcPeerConnectionInstance.setRemoteDescription(new RTCSessionDescription(message.video));
      }
      
      if (message.candidate) {
        // 新增對方 IP 候選位置
        // console.log('student get candidate time: ' + new Date().getTime());
        rtcPeerConnectionInstance.addIceCandidate(new RTCIceCandidate(message.candidate));
      }
    });

    sendStreamRequestBtn.addEventListener('click', async function() {
      try {
        if (!rtcPeerConnectionInstance) {
          console.log('尚未開啟視訊');
          return;
        }
        offerSdpDescription = await rtcPeerConnectionInstance[`createOffer`](signalOption);
        // 設定本地流配置
        await rtcPeerConnectionInstance.setLocalDescription(offerSdpDescription);
        socket.emit("studentSendToTeacherSignaling", {name: studentName, video: rtcPeerConnectionInstance.localDescription});
      } catch(err) {
        console.log(err);
      }
    });

    async function initPeerConnection() {
      const configuration = {
        iceServers: [{
          urls: 'stun:stun.l.google.com:19302' // Google's public STUN server
        }]
      };
      rtcPeerConnectionInstance = new RTCPeerConnection(configuration);

      localShareScreenVideoStream = await navigator.mediaDevices.getDisplayMedia({ audio: false, video: true })
      localVideoCallVideoStream = await navigator.mediaDevices.getUserMedia({ audio: false, video: true })
      shareScreenVideo.srcObject = localShareScreenVideoStream;
      videoCallVideo.srcObject = localVideoCallVideoStream;

      const test1 = localShareScreenVideoStream.getVideoTracks()[0];
      rtcPeerConnectionInstance.addTrack(test1, localShareScreenVideoStream);

      const test2 = localVideoCallVideoStream.getVideoTracks()[0];
      rtcPeerConnectionInstance.addTrack(test2, localVideoCallVideoStream);
      

      const senders = rtcPeerConnectionInstance.getSenders();

      // 遍历发送器数组，检查每个发送器的轨道信息
      senders.forEach(sender => {
        // 获取发送器的轨道信息
        const track = sender.track;

        console.log('Track :', track);
        if (track) {
          // 如果轨道存在，则打印轨道的种类和标识符
          console.log(`Track kind: ${track.kind}, track ID: ${track.id}`);
        } else {
          // 如果轨道不存在，则打印未找到轨道的消息
          console.log('No track found');
        }
      });

      // 找尋到 ICE 候選位置後，送去 Server 與另一位配對
      rtcPeerConnectionInstance.onicecandidate = ({ candidate }) => {
        if (!candidate) { return; }
        // console.log('onIceCandidate => ', candidate);
        socket.emit("studentSendToTeacherSignaling", { candidate: candidate });
      };

      rtcPeerConnectionInstance.oniceconnectionstatechange = (evt) => {
        console.log('ICE 伺服器狀態變更 => ', evt.target.iceConnectionState);
      };

      socket.emit('joinRoom' , 'teacher_room');
    }

    initPeerConnection();

  </script>
</html>



