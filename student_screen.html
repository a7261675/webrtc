<html>
  <head>
  </head>
  <body>
    <div>
      <label id="student_id_label">學號</label>
        <input type="text" name="student_id_input" id="student_id_input" placeholder="請輸入學號">
        <label id="student_name_label">學生姓名</label>
        <input type="text" name="student_name_input" id="student_name_input" placeholder="請輸入學生姓名">
        <button id="authenticate_student_btn">驗證學生身份</button>
        <p id="authenticate_student_error_message"></p>
    </div>
    <div>
        <video width="1000" height="1000" autoplay
          id="share_screen_video" muted playsinline></video>
        <video width="1000" height="1000" autoplay
          id="video_call_video" muted playsinline></video>

          <button id="send_stream_request_btn">send stream</button>
    </div>
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    const shareScreenVideo = document.querySelector('#share_screen_video');
    const videoCallVideo = document.querySelector('#video_call_video');
    let share_screen_RTC_peer_connection_instance;
    let video_call_RTC_peer_connection_instance;
    // 連線到 Server Port
    const socket = io('http://localhost:7000');
    const configuration = {
      iceServers: [{
        urls: 'stun:stun.l.google.com:19302' // Google's public STUN server
      }]
    };
    const signalOption = {
      offerToReceiveAudio: 1, // 是否傳送聲音流給對方
      offerToReceiveVideo: 1, // 是否傳送影像流給對方
    };

    // Client
    socket.on('teacher_to_student', async (video_message) => {
      console.log('===== 7 取得老師端回應 =====');
      console.log('時間: ', new Date().getTime());
      if (video_message.share_screen_video && !share_screen_RTC_peer_connection_instance.currentRemoteDescription) {
        console.log('===== 7-1 share screen set remote description =====');
        console.log('時間: ', new Date().getTime());
        await share_screen_RTC_peer_connection_instance.setRemoteDescription(new RTCSessionDescription(video_message.share_screen_video));
      }

      if (video_message.video_call_video && !video_call_RTC_peer_connection_instance.currentRemoteDescription) {
        console.log('===== 7-2 video call set remote description =====');
        console.log('時間: ', new Date().getTime());
        await video_call_RTC_peer_connection_instance.setRemoteDescription(new RTCSessionDescription(video_message.video_call_video));
      }
      
      if (video_message.candidate) {
        console.log('===== 9 add ice candidate =====');
        console.log('類別: ', video_message.type, ', 時間: ', new Date().getTime());
        // 新增對方 IP 候選位置
        if(video_message.type == 'share_screen') {
          await share_screen_RTC_peer_connection_instance.addIceCandidate(new RTCIceCandidate(video_message.candidate));
        }

        if(video_message.type == 'video_call') {
          await video_call_RTC_peer_connection_instance.addIceCandidate(new RTCIceCandidate(video_message.candidate));
        }
      }
    });

    async function createPeerConnectionInstance(type) {
      if (!shareScreenVideo.srcObject || !videoCallVideo.srcObject) {
        console.log('視訊或螢幕分享尚未開啟');
        return;
      }
      console.log('===== 1 create connection =====');
      console.log('create connection time: ' + new Date().getTime());
      var peerConnectionInstance = new RTCPeerConnection(configuration);
      if(type == 'share_screen') {
        console.log('===== 2-1 share screen add stream =====');
        console.log('share screen add stream time: ' + new Date().getTime());
        peerConnectionInstance.addStream(shareScreenVideo.srcObject);
      } else if(type == 'video_call') {
        console.log('===== 2-2 video call add stream =====');
        console.log('video call add stream time: ' + new Date().getTime());
        peerConnectionInstance.addStream(videoCallVideo.srcObject);
      } else {
        console.log('error video type!!!!');
      }
      
      // 找尋到 ICE 候選位置後，送去 Server 與另一位配對
      peerConnectionInstance.onicecandidate = ({ candidate }) => {
        console.log('===== 6 on ice candidate =====');
        console.log('類別: ', type, ', 時間: ', new Date().getTime());
        console.log('candidate: ', candidate);
        if (!candidate) { return; }
        socket.emit("student_to_teacher", {
          candidate: candidate
        });
      };
      peerConnectionInstance.oniceconnectionstatechange = (evt) => {
        console.log('===== 8 on ice connection state change =====');
        console.log('類別: ', type, ', 時間: ', new Date().getTime());
        console.log('ICE 伺服器狀態變更 => ', evt.target.iceConnectionState);
      };
      peerConnectionInstance.onaddstream = (event) => {
        console.log('===== 10 on add stream =====');
        console.log('類別: ', type, ', 時間: ', new Date().getTime());
        console.log('接收流並顯示於遠端視訊！', event);
      }
      console.log('===== 3 create offer description =====');
      console.log('類別: ', type, ', 時間: ', new Date().getTime());
      // 呼叫 peerConnect 內的 createOffer / createAnswer
      peerOfferSdpDescription = await peerConnectionInstance[`createOffer`](signalOption);
      console.log('===== 4 set local description =====');
      console.log('類別: ', type, ', 時間: ', new Date().getTime());
      // 設定本地流配置
      await peerConnectionInstance.setLocalDescription(peerOfferSdpDescription);

      if(type == 'share_screen') {
        share_screen_RTC_peer_connection_instance = peerConnectionInstance;
      } else if(type == 'video_call') {
        video_call_RTC_peer_connection_instance = peerConnectionInstance;
      } else {
        console.log('error video type!!!!');
      }

      return peerConnectionInstance.localDescription;
    }

    $("#send_stream_request_btn").click(async function() {
      try {
        var tmp1 = await createPeerConnectionInstance('share_screen');
        var tmp2 = await createPeerConnectionInstance('video_call');
        console.log('===== 5 send local description to server =====');
        console.log('時間: ' + new Date().getTime());
        socket.emit("student_to_teacher", {
          student_id: $('input[name=student_id_input]').val(), 
          student_name: $('input[name=student_name_input]').val(), 
          share_screen_video: tmp1,
          video_call_video: tmp2,
        });
      } catch(err) {
        console.log(err);
      }
    });

    async function getVideoStream() {
      shareScreenVideo.srcObject = await navigator.mediaDevices.getDisplayMedia({ audio: false, video: true });
      videoCallVideo.srcObject = await navigator.mediaDevices.getUserMedia({ audio: false, video: true });
      // $('#share_screen_video').attr('src', await navigator.mediaDevices.getDisplayMedia({ audio: false, video: true }));
      // $('#video_call_video').attr('src', await navigator.mediaDevices.getUserMedia({ audio: false, video: true }));
    }

    $("#authenticate_student_btn").click(function() {
            $("#authenticate_student_error_message").text("");
            var student = {};
            student.id = $('input[name=student_id_input]').val();
            student.name = $('input[name=student_name_input]').val();
            $.ajax({
                data: {student_data: student},
                url: '/authenticate_student_data', 
                dataType: 'json',
                method: 'post',
                cache: false,
                timeout: 5000
            })
            .done(function(data){
              if(data.result.length == 0) {
                $("#authenticate_student_error_message").text("學號或姓名錯誤");
              } else {
                student_data_in_database = data.result[0];
                if(student_data_in_database.student_id == student.id && student_data_in_database.student_name == student.name) {
                  getVideoStream();
                  socket.emit('joinRoom' , 'teacher_room');
                }
              }
              console.log("post success");
            })
            .fail(function(data){
                console.log(data);
                console.log("post failed!!!!!");
            });
        });
  </script>
</html>



