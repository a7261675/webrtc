<html>
  <head>
  </head>
  <body>
    <div>
        <video width="800" height="800" autoplay
          id="share_screen_video" muted playsinline></video>
        <video width="800" height="800" autoplay
          id="video_call_video" muted playsinline></video>
    </div>
    <div>
        <button id="send_stream_request_btn">開始串流</button>
        <button id="stop_stream_request_btn">停止串流</button>
        <div id="download_button"></div>
    </div>

  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    const shareScreenVideo = document.querySelector('#share_screen_video');
    const videoCallVideo = document.querySelector('#video_call_video');
    let localShareScreenVideoStream;
    let localVideoCallVideoStream;
    let share_screen_RTC_peer_connection_instance;
    let video_call_RTC_peer_connection_instance;
    // 連線到 Server Port
    const socket = io(process.env.domain);
    const configuration = {
      iceServers: [{
        urls: 'stun:stun.l.google.com:19302' // Google's public STUN server
      }]
    };
    const configuration2 = {
      iceServers: [{
        urls: 'stun:stun.ideasip.com'
      }]
    };
    const signalOption = {
      offerToReceiveAudio: 1, // 是否傳送聲音流給對方
      offerToReceiveVideo: 1, // 是否傳送影像流給對方
    };

    // Client
    socket.on('teacher_to_student_share_screen_request', async (video_message) => {
      console.log('teacher to student share screen');
      if (video_message.share_screen_video && !share_screen_RTC_peer_connection_instance.currentRemoteDescription) {
        console.log('teacher to student share screen set remote description');
        console.log(video_message);
        await share_screen_RTC_peer_connection_instance.setRemoteDescription(new RTCSessionDescription(video_message.share_screen_video));
      }
      
      if (video_message.candidate) {
        console.log('teacher to student share screen add candidate');
        console.log(video_message.candidate);
        // 新增對方 IP 候選位置
        share_screen_RTC_peer_connection_instance.addIceCandidate(new RTCIceCandidate(video_message.candidate));
      }
    });

    socket.on('teacher_to_student_video_call_request', async (video_message) => {
      if (video_message.video_call_video && !video_call_RTC_peer_connection_instance.currentRemoteDescription) {
        await video_call_RTC_peer_connection_instance.setRemoteDescription(new RTCSessionDescription(video_message.video_call_video));
      }
      
      if (video_message.candidate) {
        // 新增對方 IP 候選位置
        video_call_RTC_peer_connection_instance.addIceCandidate(new RTCIceCandidate(video_message.candidate));
      }
    });

    async function createShareScreenPeerConnectionInstance() {
      var mediaRecorder;
      localShareScreenVideoStream = await navigator.mediaDevices.getDisplayMedia({ audio: false, video: true });
      shareScreenVideo.srcObject = localShareScreenVideoStream;
      share_screen_RTC_peer_connection_instance = new RTCPeerConnection(configuration);
      share_screen_RTC_peer_connection_instance.addStream(shareScreenVideo.srcObject);
      // 找尋到 ICE 候選位置後，送去 Server 與另一位配對
      share_screen_RTC_peer_connection_instance.onicecandidate = ({ candidate }) => {
        if (!candidate) { return; }
        socket.emit("student_to_teacher_share_screen_request", {
          candidate: candidate
        });
      };
      share_screen_RTC_peer_connection_instance.oniceconnectionstatechange = (evt) => {
        console.log('===== 8 share screen on ice connection state change =====');
        console.log('ICE 伺服器狀態變更 => ', evt.target.iceConnectionState);
        if(evt.target.iceConnectionState == 'connected') {
          console.log(', 分享桌面: ICE 伺服器成功連線');
          // console.log(shareScreenVideo.srcObject);
            
          const chunks = [];
          mediaRecorder.ondataavailable = e => chunks.push(e.data);
          mediaRecorder.onstop = e => {
            const blob = new Blob(chunks, { type: chunks[0].type });
            console.log(blob);
            // share_screen_video_element.srcObject.getVideoTracks()[0].stop();
            filename = '桌面分享.mp4';
            if(window.navigator.msSaveOrOpenBlob) {
                window.navigator.msSaveBlob(blob, filename);
            } else {
                var download_button = window.document.createElement('a');
                download_button.href = window.URL.createObjectURL(blob);
                download_button.download = filename;
                download_button.innerHTML = "桌面分享下載";
                $(`#download_button`).append(download_button);
                // document.body.appendChild(download_button);
                // elem.click();     
                // document.body.removeChild(elem);
            }
          };
          mediaRecorder.start();
        }
      };
      
      var share_screen_channel = share_screen_RTC_peer_connection_instance.createDataChannel("share screen channel");
      share_screen_channel.onclose = () => {
        mediaRecorder.stop();
      };

      share_screen_RTC_peer_connection_instance.onaddstream = (event) => {
        console.log('接收流並顯示於桌面分享！', event);
        mediaRecorder = new MediaRecorder(shareScreenVideo.srcObject);
      }
    }

    async function createVideoCallPeerConnectionInstance() {
      var mediaRecorder;
      localVideoCallVideoStream = await navigator.mediaDevices.getUserMedia({ audio: false, video: true })
      videoCallVideo.srcObject = localVideoCallVideoStream;
      video_call_RTC_peer_connection_instance = new RTCPeerConnection(configuration2);
      video_call_RTC_peer_connection_instance.addStream(videoCallVideo.srcObject);
      // 找尋到 ICE 候選位置後，送去 Server 與另一位配對
      video_call_RTC_peer_connection_instance.onicecandidate = ({ candidate }) => {
        if (!candidate) { return; }
        socket.emit("student_to_teacher_video_call_request", {
          candidate: candidate
        });
      };
      video_call_RTC_peer_connection_instance.oniceconnectionstatechange = (evt) => {
        console.log('===== 8 video call on ice connection state change =====');
        console.log('ICE 伺服器狀態變更 => ', evt.target.iceConnectionState);
        if(evt.target.iceConnectionState == 'connected') {
          console.log(', 分享視訊: ICE 伺服器成功連線');
          console.log(videoCallVideo.srcObject);
            
          const chunks = [];
          mediaRecorder.ondataavailable = e => chunks.push(e.data);
          mediaRecorder.onstop = e => {
            const blob = new Blob(chunks, { type: chunks[0].type });
            console.log(blob);
            // share_screen_video_element.srcObject.getVideoTracks()[0].stop();
            filename = '視訊分享.mp4';
            if(window.navigator.msSaveOrOpenBlob) {
                window.navigator.msSaveBlob(blob, filename);
            } else {
                var download_button = window.document.createElement('a');
                download_button.href = window.URL.createObjectURL(blob);
                download_button.download = filename;
                download_button.innerHTML = "視訊分享下載";
                $(`#download_button`).append(download_button);
                // document.body.appendChild(download_button);
                // elem.click();     
                // document.body.removeChild(elem);
            }
          };
          mediaRecorder.start();
        }
      };

      var video_call_channel = video_call_RTC_peer_connection_instance.createDataChannel("video call channel");
      video_call_channel.onclose = () => {
        mediaRecorder.stop();
      };
      video_call_RTC_peer_connection_instance.onaddstream = (event) => {
        console.log('接收流並顯示於遠端視訊！', event);
        mediaRecorder = new MediaRecorder(videoCallVideo.srcObject);
      }
    }

    $("#send_stream_request_btn").click(async function() {
      try {
        if (!share_screen_RTC_peer_connection_instance) {
          console.log('螢幕分享尚未開啟');
          return;
        }
        // 呼叫 peerConnect 內的 createOffer / createAnswer
        shareScreenOfferSdpDescription = await share_screen_RTC_peer_connection_instance[`createOffer`](signalOption);
        // 設定本地流配置
        await share_screen_RTC_peer_connection_instance.setLocalDescription(shareScreenOfferSdpDescription);

        if (!video_call_RTC_peer_connection_instance) {
          console.log('視訊裝置尚未開啟');
          return;
        }
        // 呼叫 peerConnect 內的 createOffer / createAnswer
        videoCallOfferSdpDescription = await video_call_RTC_peer_connection_instance[`createOffer`](signalOption);
        // 設定本地流配置
        await video_call_RTC_peer_connection_instance.setLocalDescription(videoCallOfferSdpDescription);

        socket.emit("student_to_teacher_share_screen_request", {
          student_id: sessionStorage.getItem('student_id'), 
          student_name: sessionStorage.getItem('student_name'), 
          share_screen_video: share_screen_RTC_peer_connection_instance.localDescription,
        });

        socket.emit("student_to_teacher_video_call_request", {
          student_id: sessionStorage.getItem('student_id'), 
          student_name: sessionStorage.getItem('student_name'), 
          video_call_video: video_call_RTC_peer_connection_instance.localDescription,
        });
      } catch(err) {
        console.log(err);
      }
    });

    $("#stop_stream_request_btn").click(async function() {
      // var share_screen_video_stream = document.querySelector(`[id='share_screen_video']`).srcObject;
      // share_screen_video_stream.getTracks().forEach((track) => {
      //   track.stop();
      // });
      // document.querySelector(`[id='share_screen_video']`).srcObject = null;
      
      // var video_call_video_stream = document.querySelector(`[id='video_call_video']`).srcObject;
      // video_call_video_stream.getTracks().forEach((track) => {
      //   track.stop();
      // });
      // document.querySelector(`[id='video_call_video']`).srcObject = null;

        // socket.emit("student_to_teacher_stop_video_stream", {
        //   student_id: localStorage.getItem('student_id'),
        //   student_name: localStorage.getItem('student_name'),
        //   command: 'stop',
        // });
        share_screen_RTC_peer_connection_instance.close();
        video_call_RTC_peer_connection_instance.close();
    });


    function getId() {
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      return urlParams.get('test_room_id');
    }
    
    createShareScreenPeerConnectionInstance();
    createVideoCallPeerConnectionInstance();
    socket.emit('joinRoom' , 'teacher_room_' + getId());
  </script>
</html>



