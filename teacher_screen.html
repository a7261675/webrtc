<html>
  <head>
  </head>
  <body>
    <div>
      <label id = "studentName_0"></label>
        <video width="500" height="500" autoplay
          id="remoteShareScreenVideo_0" playsinline></video>
        <video width="500" height="500" autoplay
          id="rmeoteVideoCallVideo_0" playsinline></video>
          
          <label id = "studentName_1"></label>
        <video width="500" height="500" autoplay
          id="remoteShareScreenVideo_1" playsinline></video>
          <video width="500" height="500" autoplay
          id="rmeoteVideoCallVideo_1" playsinline></video>
          
          <label id = "studentName_2"></label>
        <video width="500" height="500" autoplay
          id="remoteShareScreenVideo_2" playsinline></video>
          <video width="500" height="500" autoplay
          id="rmeoteVideoCallVideo_2" playsinline></video>
    </div>
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    // 連線到 Server Port
    const socket = io('http://localhost:3000');
    let localstream;
    let rtcPeerConnectionInstance_0;
    let rtcPeerConnectionInstance_1;
    let rtcPeerConnectionInstance_2;
    let rtcPeerConnectionInstanceList = [
      rtcPeerConnectionInstance_0, 
      rtcPeerConnectionInstance_1, 
      rtcPeerConnectionInstance_2
    ];
    let now = 0;

    const signalOption = {
      offerToReceiveAudio: 1, // 是否傳送聲音流給對方
      offerToReceiveVideo: 1, // 是否傳送影像流給對方
    };

    // Client
    socket.on('studentSendToTeacherSignaling', async (message) => {
      if (message.video && !rtcPeerConnectionInstanceList[now].currentRemoteDescription) {
        $(`#studentName_${now}`).text(message.name);
        try {
          await rtcPeerConnectionInstanceList[now].setRemoteDescription(new RTCSessionDescription(message.video));
          if (!rtcPeerConnectionInstanceList[now]) {
            console.log('尚未開啟視訊');
            return;
          }
          offerSdpDescription = await rtcPeerConnectionInstanceList[now][`createAnswer`](signalOption);
          await rtcPeerConnectionInstanceList[now].setLocalDescription(offerSdpDescription);
          socket.emit("teacherSendToStudentSignaling", { video: rtcPeerConnectionInstanceList[now].localDescription });
        } catch(err) {
          console.log(err);
        }
      }
      
      if (message.candidate) {
        // 新增對方 IP 候選位置
        console.log('=================================== step 13 teacher get candidate =======================================');
        console.log('teacher get candidate time: ' + new Date().getTime());
        console.log('now: ' + now);
        console.log('add candidate =>', message.candidate);
        rtcPeerConnectionInstanceList[now].addIceCandidate(new RTCIceCandidate(message.candidate));
      }
    });

    async function initPeerConnection(i) {
      localstream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true })
      const configuration = {
        iceServers: [{
          urls: 'stun:stun.l.google.com:19302' // Google's public STUN server
        }]
      };
      rtcPeerConnectionInstanceList[i] = new RTCPeerConnection(configuration);
      rtcPeerConnectionInstanceList[i].addStream(localstream.clone())
      rtcPeerConnectionInstanceList[i].onicecandidate = ({ candidate }) => {
        if (!candidate) { return; }
        console.log('onIceCandidate => ', candidate);
        socket.emit("teacherSendToStudentSignaling", { candidate: candidate });
      };
      rtcPeerConnectionInstanceList[i].oniceconnectionstatechange = (evt) => {
        console.log('ICE 伺服器狀態變更 => ', evt.target.iceConnectionState);
        console.log('狀態變更時間: ' + new Date().getTime());
        if (evt.target.iceConnectionState == 'connected') {
          console.log('連線完成時間: ' + new Date().getTime());
          console.log('now: ' + now);
          now++;
        }
      };
      rtcPeerConnectionInstanceList[i].onaddstream = (event) => {
        var remoteShareScreenVideo = document.querySelector(`#remoteShareScreenVideo_${i}`); 
        var remoteVideoCallVideo = document.querySelector(`#remoteVideoCallVideo_${i}`); 
        console.log('==================================================== event ==================================================');
        console.log(event);
        console.log('==================================================== event ==================================================');
        // const remoteStreams = event.streams;
        event.streams.forEach(stream => {
          stream.getTracks().forEach(track => {
            if(track.kind == 'video') {
              if(track.label.includes('screen')) {
                if(!remoteShareScreenVideo.srcObject){
                  remoteShareScreenVideo.srcObject = stream;
                  console.log('接收流並顯示於遠端分享桌面！', event);
                }
                remoteShareScreenVideo.addEventListener('click', async function() {
                    if (remoteShareScreenVideo.requestFullscreen) {
                      remoteShareScreenVideo.requestFullscreen();
                    } else if (remoteShareScreenVideo.webkitRequestFullscreen) { /* Safari */
                      remoteShareScreenVideo.webkitRequestFullscreen();
                    } else if (remoteShareScreenVideo.msRequestFullscreen) { /* IE11 */
                      remoteShareScreenVideo.msRequestFullscreen();
                    }
                });
              } else {
                if(!remoteVideoCallVideo.srcObject){
                  remoteVideoCallVideo.srcObject = stream;
                  console.log('接收流並顯示於遠端分享桌面！', event);
                }
                remoteVideoCallVideo.addEventListener('click', async function() {
                    if (remoteVideoCallVideo.requestFullscreen) {
                      remoteVideoCallVideo.requestFullscreen();
                    } else if (remoteVideoCallVideo.webkitRequestFullscreen) { /* Safari */
                      remoteVideoCallVideo.webkitRequestFullscreen();
                    } else if (remoteVideoCallVideo.msRequestFullscreen) { /* IE11 */
                      remoteVideoCallVideo.msRequestFullscreen();
                    }
                });

              }
            }
          })
        })
      }
    }

    initPeerConnection(0);
    initPeerConnection(1);
    initPeerConnection(2);
    socket.emit('joinRoom' , 'teacher_room');

  </script>
</html>



