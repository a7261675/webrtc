<html>
  <head>
  </head>
  <body>
    <div>
      <label id = "studentName_0"></label>
        <video width="500" height="500" autoplay
          id="remoteShareScreenVideo_0" playsinline></video>
        <video width="500" height="500" autoplay
          id="remoteVideoCallVideo_0" playsinline></video>
          
          <label id = "studentName_1"></label>
        <video width="500" height="500" autoplay
          id="remoteShareScreenVideo_1" playsinline></video>
          <video width="500" height="500" autoplay
          id="remoteVideoCallVideo_1" playsinline></video>
          
          <label id = "studentName_2"></label>
        <video width="500" height="500" autoplay
          id="remoteShareScreenVideo_2" playsinline></video>
          <video width="500" height="500" autoplay
          id="remoteVideoCallVideo_2" playsinline></video>
    </div>
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    // 連線到 Server Port
    const socket = io('http://localhost:3000');
    let localstream;
    let rtcPeerConnectionInstance_0;
    let rtcPeerConnectionInstance_1;
    let rtcPeerConnectionInstance_2;
    let rtcPeerConnectionInstanceList = [
      rtcPeerConnectionInstance_0, 
      rtcPeerConnectionInstance_1, 
      rtcPeerConnectionInstance_2
    ];
    let now = 0;

    const signalOption = {
      offerToReceiveAudio: 1, // 是否傳送聲音流給對方
      offerToReceiveVideo: 1, // 是否傳送影像流給對方
    };

    // Client
    socket.on('studentSendToTeacherSignaling', async (message) => {
      if (message.video && !rtcPeerConnectionInstanceList[now].currentRemoteDescription) {
        $(`#studentName_${now}`).text(message.name);
        try {
          await rtcPeerConnectionInstanceList[now].setRemoteDescription(new RTCSessionDescription(message.video));
          if (!rtcPeerConnectionInstanceList[now]) {
            console.log('尚未開啟視訊');
            return;
          }
          offerSdpDescription = await rtcPeerConnectionInstanceList[now][`createAnswer`](signalOption);
          await rtcPeerConnectionInstanceList[now].setLocalDescription(offerSdpDescription);
          socket.emit("teacherSendToStudentSignaling", { video: rtcPeerConnectionInstanceList[now].localDescription });
        } catch(err) {
          console.log(err);
        }
      }
      
      if (message.candidate) {
        rtcPeerConnectionInstanceList[now].addIceCandidate(new RTCIceCandidate(message.candidate));
      }
    });

    async function initPeerConnection(i) {
      localstream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true })
      const configuration = {
        iceServers: [{
          urls: 'stun:stun.l.google.com:19302' // Google's public STUN server
        }]
      };
      rtcPeerConnectionInstanceList[i] = new RTCPeerConnection(configuration);
      rtcPeerConnectionInstanceList[i].addStream(localstream.clone())
      rtcPeerConnectionInstanceList[i].onicecandidate = ({ candidate }) => {
        if (!candidate) { return; }
        socket.emit("teacherSendToStudentSignaling", { candidate: candidate });
      };

      rtcPeerConnectionInstanceList[i].oniceconnectionstatechange = (evt) => {
        if (evt.target.iceConnectionState == 'connected') {
          console.log('連線完成時間: ' + new Date().getTime());
          console.log('now: ' + now);
          now++;
        }
      };
      
      rtcPeerConnectionInstanceList[i].ontrack = (event) => {
        if(event.track.kind == 'video') {
          var video_element;
          if(event.transceiver.mid == 0) {
            video_element = document.querySelector(`[id='remoteShareScreenVideo_${i}']`); 
          } else if(event.transceiver.mid == 1) {
            video_element = document.querySelector(`[id='remoteVideoCallVideo_${i}']`); 
          }

          video_element.srcObject = new MediaStream([event.track]);
          if(!video_element.srcObject){
            console.log('接收流並顯示於遠端分享桌面！', event);
          }
          video_element.addEventListener('click', async function() {
            if (video_element.requestFullscreen) {
              video_element.requestFullscreen();
            } else if (video_element.webkitRequestFullscreen) { /* Safari */
              video_element.webkitRequestFullscreen();
            } else if (video_element.msRequestFullscreen) { /* IE11 */
              video_element.msRequestFullscreen();
            }
          });
        }
      }
    }

    initPeerConnection(0);
    initPeerConnection(1);
    initPeerConnection(2);
    socket.emit('joinRoom' , 'teacher_room');

  </script>
</html>



