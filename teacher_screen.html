<html>
  <head>
  </head>
  <body>
    <div id="student_video_list" style="display:flex;flex-wrap:wrap;">
    </div>
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    // 連線到 Server Port
    const socket = io('http://localhost:3000');
    const signalOption = {
      offerToReceiveAudio: 1, // 是否傳送聲音流給對方
      offerToReceiveVideo: 1, // 是否傳送影像流給對方
    };
    const configuration = {
      iceServers: [{
        urls: 'stun:stun.l.google.com:19302' // Google's public STUN server
      }]
    };
    const configuration2 = {
      iceServers: [{
        urls: 'stun:stun.ideasip.com'
      }]
    };
    let shareScreenLocalstream;
    let videoCallLocalstream;
    let shareScreenRTCPeerConnectionInstanceList = [];
    let videoCallRTCPeerConnectionInstanceList = [];

    // socket.on('student_to_teacher_stop_video_stream', async (client_information) => {
    //   var share_screen_video_stream = document.querySelector(`[id='${client_information.student_id}_share_screen_video']`).srcObject;
    //   share_screen_video_stream.getTracks().forEach((track) => {
    //     track.stop();
    //   });
    //   document.querySelector(`[id='${client_information.student_id}_share_screen_video']`).srcObject = null;

    //   var video_call_video_stream = document.querySelector(`[id='${client_information.student_id}_video_call_video']`).srcObject;
    //   video_call_video_stream.getTracks().forEach((track) => {
    //     track.stop();
    //   });
    //   document.querySelector(`[id='${client_information.student_id}_video_call_video']`).srcObject = null;
    // });

    // Client
    socket.on('student_to_teacher_share_screen_request', async (video_message) => {
      if(video_message.student_id) {
        if($("#" + video_message.student_id).length <= 0) {
          createStudentVideoDiv(video_message.student_id);
        }

        $(`#${video_message.student_id}_label`).text(video_message.student_id + ': ' + video_message.student_name);
        
        if(!shareScreenLocalstream) {
          shareScreenLocalstream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        }

        let share_screen_video_element;
        share_screen_video_element = document.querySelector(`[id='${video_message.student_id}_share_screen_video']`);

        shareScreenRTCPeerConnectionInstanceList[video_message.student_id] = new RTCPeerConnection(configuration);
        shareScreenRTCPeerConnectionInstanceList[video_message.student_id].addStream(shareScreenLocalstream.clone())
        shareScreenRTCPeerConnectionInstanceList[video_message.student_id].onaddstream = (event) => {
          if(!share_screen_video_element.srcObject && event.stream){
            console.log('接收流並顯示於遠端分享桌面！', event);
            share_screen_video_element.srcObject = event.stream;
          }
          share_screen_video_element.addEventListener('click', async function() {
              if (share_screen_video_element.requestFullscreen) {
                share_screen_video_element.requestFullscreen();
              } else if (share_screen_video_element.webkitRequestFullscreen) { /* Safari */
                share_screen_video_element.webkitRequestFullscreen();
              } else if (share_screen_video_element.msRequestFullscreen) { /* IE11 */
                share_screen_video_element.msRequestFullscreen();
              }
          });
        }

        shareScreenRTCPeerConnectionInstanceList[video_message.student_id].oniceconnectionstatechange = (evt) => {
            console.log('===== 4 share screen on ice connection state change =====');
            console.log('ICE 伺服器狀態變更 => ', evt.target.iceConnectionState);
            if (evt.target.iceConnectionState == 'connected') {
              console.log('學生: ', video_message.student_id, ', 分享桌面: ICE 伺服器成功連線');
            }
        };

        shareScreenRTCPeerConnectionInstanceList[video_message.student_id].onicecandidate = ({ candidate }) => {
          if (!candidate) { return; }
          socket.emit("teacher_to_student_share_screen_request", { candidate: candidate });
        };
        // desc 指的是 Offer 與 Answer
        // currentRemoteDescription 代表的是最近一次連線成功的相關訊息
        if (video_message.share_screen_video && !shareScreenRTCPeerConnectionInstanceList[video_message.student_id].currentRemoteDescription) {
          try {
            await shareScreenRTCPeerConnectionInstanceList[video_message.student_id].setRemoteDescription(new RTCSessionDescription(video_message.share_screen_video));
            if (!shareScreenRTCPeerConnectionInstanceList[video_message.student_id]) {
              console.log('尚未開啟螢幕分享');
              return;
            }
            // 呼叫 peerConnect 內的 createOffer / createAnswer
            shareScreenOfferSdpDescription = await shareScreenRTCPeerConnectionInstanceList[video_message.student_id][`createAnswer`](signalOption);
            // 設定本地流配置
            await shareScreenRTCPeerConnectionInstanceList[video_message.student_id].setLocalDescription(shareScreenOfferSdpDescription);
            shareScreenLocalDescription = shareScreenRTCPeerConnectionInstanceList[video_message.student_id].localDescription;

            socket.emit("teacher_to_student_share_screen_request", {
              student_id: video_message.student_id, 
              student_name: video_message.student_name, 
              share_screen_video: shareScreenLocalDescription,
            });
          } catch(err) {
            console.log(err);
          }
        }
        
        if (video_message.candidate) {
          // 新增對方 IP 候選位置
          shareScreenRTCPeerConnectionInstanceList[video_message.student_id].addIceCandidate(new RTCIceCandidate(video_message.candidate));
        }
      }
    });

    socket.on('student_to_teacher_video_call_request', async (video_message) => {
      if(video_message.student_id) {
        if($("#" + video_message.student_id).length <= 0) {
          createStudentVideoDiv(video_message.student_id);
        }

        $(`#${video_message.student_id}_label`).text(video_message.student_id + ': ' + video_message.student_name);

        if(!videoCallLocalstream) {
          videoCallLocalstream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        }

        let video_call_video_element;
        video_call_video_element = document.querySelector(`[id='${video_message.student_id}_video_call_video']`);

        videoCallRTCPeerConnectionInstanceList[video_message.student_id] = new RTCPeerConnection(configuration2);
        videoCallRTCPeerConnectionInstanceList[video_message.student_id].addStream(videoCallLocalstream.clone())
        videoCallRTCPeerConnectionInstanceList[video_message.student_id].onaddstream = (event) => {
          if(!video_call_video_element.srcObject && event.stream){
            console.log('video call on add stream', event);
            video_call_video_element.srcObject = event.stream;
          }
          video_call_video_element.addEventListener('click', async function() {
              if (video_call_video_element.requestFullscreen) {
                video_call_video_element.requestFullscreen();
              } else if (video_call_video_element.webkitRequestFullscreen) { /* Safari */
                video_call_video_element.webkitRequestFullscreen();
              } else if (video_call_video_element.msRequestFullscreen) { /* IE11 */
                video_call_video_element.msRequestFullscreen();
              }
          });
        }
      
        videoCallRTCPeerConnectionInstanceList[video_message.student_id].oniceconnectionstatechange = (evt) => {
          console.log('====== 9 video call on ice connection state change ======');
          console.log('ICE 伺服器狀態變更 => ', evt.target.iceConnectionState);
          if(evt.target.iceConnectionState == 'connected') {
            console.log('學生: ', video_message.student_id, ', 分享視訊: ICE 伺服器成功連線');
          }
        };

        videoCallRTCPeerConnectionInstanceList[video_message.student_id].onicecandidate = ({ candidate }) => {
          console.log('video call rtc peer connection: on ice candidate');
          console.log(candidate);
          if (!candidate) { return; }
          socket.emit("teacher_to_student_video_call_request", { candidate: candidate });
        };
        // desc 指的是 Offer 與 Answer
        // currentRemoteDescription 代表的是最近一次連線成功的相關訊息
        if (video_message.video_call_video && !videoCallRTCPeerConnectionInstanceList[video_message.student_id].currentRemoteDescription) {
          try {
            await videoCallRTCPeerConnectionInstanceList[video_message.student_id].setRemoteDescription(new RTCSessionDescription(video_message.video_call_video));
            if (!videoCallRTCPeerConnectionInstanceList[video_message.student_id]) {
              console.log('尚未開啟視訊');
              return;
            }
            // 呼叫 peerConnect 內的 createOffer / createAnswer
            videoCallOfferSdpDescription = await videoCallRTCPeerConnectionInstanceList[video_message.student_id][`createAnswer`](signalOption);
            // 設定本地流配置
            await videoCallRTCPeerConnectionInstanceList[video_message.student_id].setLocalDescription(videoCallOfferSdpDescription);
            videoCallLocalDescription = videoCallRTCPeerConnectionInstanceList[video_message.student_id].localDescription;
            socket.emit("teacher_to_student_video_call_request", {
              student_id: video_message.student_id, 
              student_name: video_message.student_name, 
              video_call_video: videoCallLocalDescription,
            });
          } catch(err) {
            console.log(err);
          }
        }

        if (video_message.candidate) {
          videoCallRTCPeerConnectionInstanceList[video_message.student_id].addIceCandidate(new RTCIceCandidate(video_message.candidate));
        }
      }
    });

    function createStudentVideoDiv(student_id) {
      $("#student_video_list").append(`
        <div id="${student_id}" width="45%" height="50%" style="display:inline-block">
            <div><label id="${student_id}_label"></label></div>
            <div id="${student_id}_video_list">
              <video width="400px" height="500px" autoplay id="${student_id}_share_screen_video" playsinline></video>
              <video width="400px" height="500px" autoplay id="${student_id}_video_call_video" playsinline></video> 
            </div>
        </div>
      `);
    }
    
    function getId() {
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      return urlParams.get('id');
    }

    socket.emit('joinRoom' , 'teacher_room_' + getId());
  </script>
</html>