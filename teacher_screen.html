<html>
  <head>
  </head>
  <body>
    <div>  
        <button class="joinBtn">join room</button>

        <video width="500" height="500" autoplay
          id="remoteVideo" playsinline></video>
      </div>
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script>

    // 連線到 Server Port
    const socket = io('http://localhost:3000');

    const myVideo = document.querySelector('#myVideo');
    const joinBtn = document.querySelector('.joinBtn');
    let localstream;
    let pc; 

function joinRoom() {
  socket.emit('joinRoom' , 'teacher_room');
};
joinBtn.addEventListener('click', joinRoom);

//以下還不能動
const remoteVideo = document.querySelector('#remoteVideo');

async function initPeerConnection() {
  localstream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true })
  const configuration = {
    iceServers: [{
      urls: 'stun:stun.l.google.com:19302' // Google's public STUN server
    }]
   };
  pc = new RTCPeerConnection(configuration);
  pc.addStream(localstream)
  pc.onicecandidate = ({ candidate }) => {
    if (!candidate) { return; }
    console.log('onIceCandidate => ', candidate);
    socket.emit("peerconnectSignaling", { candidate });
  };
  pc.oniceconnectionstatechange = (evt) => {
    console.log('ICE 伺服器狀態變更 => ', evt.target.iceConnectionState);
  };
  pc.onaddstream = (event) => {
    console.log('this is onaddstream');
    if(!remoteVideo.srcObject && event.stream){
      remoteVideo.srcObject = event.stream;
      console.log('接收流並顯示於遠端視訊！', event);
    }
  }
}

// Client
socket.on('peerconnectSignaling', async ({ desc, candidate }) => {
  // desc 指的是 Offer 與 Answer
  // currentRemoteDescription 代表的是最近一次連線成功的相關訊息
  if (desc && !pc.currentRemoteDescription) {
    console.log('desc => ', desc);
    
    await pc.setRemoteDescription(new RTCSessionDescription(desc));
    createSignal(desc.type === 'answer' ? true : false);
  } else if (candidate) {
    // 新增對方 IP 候選位置
    console.log('candidate =>', candidate);
    pc.addIceCandidate(new RTCIceCandidate(candidate));
  }
});

let offer;

const signalOption = {
  offerToReceiveAudio: 1, // 是否傳送聲音流給對方
  offerToReceiveVideo: 1, // 是否傳送影像流給對方
};

async function createSignal(isOffer) {
  console.log('this is createSignal');
  try {
    if (!pc) {
      console.log('尚未開啟視訊');
      return;
    }
    // 呼叫 peerConnect 內的 createOffer / createAnswer
    offer = await pc[`create${isOffer ? 'Offer' : 'Answer'}`](signalOption);
    // 設定本地流配置
    await pc.setLocalDescription(offer);
    desc = pc.localDescription;
    socket.emit("peerconnectSignaling", { desc });
  } catch(err) {
    console.log(err);
  }
};

initPeerConnection();

  </script>
</html>



